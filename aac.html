<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AAC ë³´ë“œ (ì •ë ¬/í¸ì§‘/íƒ­ì¶”ê°€/í¬ê¸°ì¡°ì ˆ/ë‚´ë³´ë‚´ê¸°)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --icon-size: 40px;          /* ì´ëª¨ì§€/í…ìŠ¤íŠ¸ ì•„ì´ì½˜ í¬ê¸° */
      --image-height: 110px;      /* ì‚¬ì§„ ì¹´ë“œ ë†’ì´ */
      --card-min-height: 130px;   /* ì¹´ë“œ ì „ì²´ ë†’ì´ */
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f4f6f8;
      color: #333;
    }

    header {
      background: #3498db;
      color: white;
      padding: 10px 12px 8px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0 0 4px;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
      justify-content: space-between;
    }

    /* íƒ­ ì˜ì—­ */
    .tabs-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .tab {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      background: rgba(255,255,255,0.2);
      color: #ecf0f1;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .tab:active {
      cursor: grabbing;
    }
    .tab.active {
      background: #fff;
      color:#3498db;
      font-weight: 600;
    }
    .tab.drag-over {
      outline: 2px dashed #ecf0f1;
    }
    .tab-delete {
      font-size: 10px;
      border: none;
      background: transparent;
      color: #c0392b;
      cursor: pointer;
      padding: 0 2px;
    }
    .btn-tab-add {
      border: none;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      background: rgba(0,0,0,0.15);
      color:#ecf0f1;
      cursor: pointer;
      margin-top: 2px;
      align-self: flex-start;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .btn-add {
      background: #2ecc71;
      color: #fff;
    }
    .btn-add:active { background:#27ae60; }

    .btn-secondary {
      background:#ecf0f1;
      color:#34495e;
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      flex: 1;
    }

    /* í¬ê¸° + ìŒì„± ì„¤ì • */
    .size-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 11px;
      color: #ecf0f1;
      justify-content: flex-end;
    }
    .size-controls label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .size-controls input[type="range"] {
      width: 70px;
    }
    #voiceSelect {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
      border: none;
      max-width: 140px;
    }

    main {
      padding: 8px;
      padding-bottom: 80px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 8px;
    }

    .card {
      position: relative;
      background: white;
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 4px;
      cursor: grab;
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.06s ease;
      min-height: var(--card-min-height);
      text-align: center;
    }
    .card:active {
      cursor: grabbing;
      transform: scale(0.97);
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      background: #e8f4ff;
    }
    .card.dragging {
      opacity: 0.7;
    }
    .card.drag-over {
      outline: 2px dashed #3498db;
    }

    .card .icon {
      font-size: var(--icon-size);
      margin-bottom: 4px;
    }
    .card-img {
      width: 100%;
      height: var(--image-height);
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 4px;
    }
    .label {
      font-size: 13px;
      font-weight: 600;
    }
    .sub {
      font-size: 11px;
      color:#7f8c8d;
    }

    /* ì‚­ì œ/í¸ì§‘ ë²„íŠ¼ */
    .card-delete-btn,
    .card-edit-btn {
      position: absolute;
      top: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 3;
    }
    .card-delete-btn { right: 4px; }
    .card-edit-btn   { right: 28px; }
    .card-delete-btn:hover,
    .card-edit-btn:hover { background: rgba(0,0,0,0.8); }
    .card-delete-btn:active,
    .card-edit-btn:active { transform: scale(0.9); }

    .hint {
      font-size: 11px;
      color:#7f8c8d;
      margin-bottom:6px;
    }

    /* í•˜ë‹¨ ë¬¸ì¥ì°½ */
    .sentence-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ffffff;
      border-top: 1px solid #dde2e6;
      padding: 6px 8px;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .sentence-text {
      flex: 1;
      min-height: 38px;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #ccd1d9;
      background: #f7f9fb;
      overflow-y: auto;
      max-height: 70px;
    }
    .bottom-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      gap: 2px;
      min-width: 48px;
    }
    .btn-speak {
      background: #e67e22;
      color: #fff;
    }
    .btn-speak:active { background:#d35400; }
    .btn-clear {
      background:#bdc3c7;
      color:#2c3e50;
    }
    .btn-clear:active { background:#95a5a6; }
    .bottom-btn span.small { font-size: 10px; }

    /* ëª¨ë‹¬ ê³µí†µ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal {
      background:#fff;
      border-radius: 12px;
      padding: 12px;
      width: min(360px, 92vw);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .modal label {
      font-size: 12px;
      display:block;
      margin-top:6px;
      margin-bottom:2px;
    }
    .modal input[type="text"],
    .modal textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccd1d9;
      padding: 6px 8px;
      font-size: 13px;
    }
    .modal textarea {
      resize: vertical;
      min-height: 50px;
    }
    .modal input[type="file"] {
      font-size: 12px;
      margin-top: 4px;
    }
    .modal-footer {
      display:flex;
      justify-content:flex-end;
      gap: 6px;
      margin-top: 10px;
    }
    .btn-primary {
      background:#3498db;
      color:#fff;
    }

    @media (min-width: 600px) {
      header h1 { font-size: 20px; }
    }
  </style>
</head>
<body>
<header>
  <h1>
    <span>AAC ë³´ë“œ</span>
    <span style="font-size:12px; opacity:0.9;">ë§í•˜ëŠ” ë³´ë“œ</span>
  </h1>

  <div class="top-row">
    <!-- íƒ­ + íƒ­ì¶”ê°€ -->
    <div class="tabs-wrap">
      <div class="tabs" id="tabs"></div>
      <button class="btn-tab-add" id="btnAddTab">ï¼‹ íƒ­ ì¶”ê°€</button>
      <button class="btn btn-add" id="btnOpenAddModal">ï¼‹ ì‚¬ìš©ì ë²„íŠ¼ ì¶”ê°€</button>
      <!-- ë°ì´í„° ë‚´ë³´ë‚´ê¸° / ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
      <button class="btn btn-secondary" id="btnExport">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
      <label class="btn btn-secondary" style="cursor:pointer;">
        ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        <input type="file" id="btnImport" accept="application/json" style="display:none;">
      </label>
    </div>

    <!-- í¬ê¸° + ìŒì„± ì„¤ì • -->
    <div class="header-actions">
      <div class="size-controls">
        <label>ì•„ì´ì½˜
          <input type="range" id="iconSizeRange" min="28" max="72" value="40">
        </label>
        <label>ì‚¬ì§„
          <input type="range" id="imgSizeRange" min="80" max="200" value="110">
        </label>
        <label>ì¹´ë“œ
          <input type="range" id="cardSizeRange" min="90" max="220" value="130">
        </label>
      </div>
      <div class="size-controls">
        <label>ë³¼ë¥¨
          <input type="range" id="volumeRange" min="0" max="100" value="100">
        </label>
        <label>ì†ë„
          <input type="range" id="rateRange" min="50" max="150" value="100">
        </label>
        <label>í†¤
          <input type="range" id="pitchRange" min="50" max="150" value="100">
        </label>
        <label>ëª©ì†Œë¦¬
          <select id="voiceSelect">
            <option value="">ê¸°ë³¸</option>
          </select>
        </label>
      </div>
    </div>
  </div>
</header>

<main>
  <div id="hintStar" class="hint">
    â­ ìì£¼ ì“°ëŠ” ë§ì€, ë§ì´ ëˆ„ë¥¸ ìˆœì„œëŒ€ë¡œ ìë™ìœ¼ë¡œ ëª¨ì—¬ìš”.
  </div>
  <div id="tabContentsContainer"></div>
</main>

<!-- í•˜ë‹¨ ë¬¸ì¥ì°½ -->
<div class="sentence-bar">
  <div id="sentenceBox" class="sentence-text"></div>
  <button class="bottom-btn btn-clear" id="btnClear">
    <span>ì§€ìš°ê¸°</span>
    <span class="small">ì „ì²´</span>
  </button>
  <button class="bottom-btn btn-speak" id="btnSpeak">
    <span>ë§í•˜ê¸°</span>
    <span class="small">ì „ì²´</span>
  </button>
</div>

<!-- ì‚¬ìš©ì ë²„íŠ¼ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="addModalBackdrop">
  <div class="modal">
    <h2>ì‚¬ìš©ì ë²„íŠ¼ ì¶”ê°€</h2>
    <p style="font-size:11px; color:#7f8c8d;">
      ì§€ê¸ˆ ì„ íƒí•œ íƒ­ì— ìƒˆ ë²„íŠ¼ì„ ë§Œë“¤ì–´ìš”.
    </p>

    <label for="addText">ë§í•˜ê³  ì‹¶ì€ ë¬¸ì¥</label>
    <textarea id="addText" placeholder="ì˜ˆ: ì—„ë§ˆ ë³´ê³  ì‹¶ì–´ìš”."></textarea>

    <label for="addSub">ì‘ì€ ì„¤ëª… (ì„ íƒ)</label>
    <input type="text" id="addSub" placeholder="ì˜ˆ: ì‚¬ì§„ ì„¤ëª… ë“±">

    <label for="addImage">ì‚¬ì§„ (ì„ íƒ)</label>
    <input type="file" id="addImage" accept="image/*">

    <div class="modal-footer">
      <button class="btn btn-secondary" type="button" id="btnAddCancel">ì·¨ì†Œ</button>
      <button class="btn btn-primary" type="button" id="btnAddSave">ì¶”ê°€</button>
    </div>
  </div>
</div>

<!-- ì¹´ë“œ í¸ì§‘ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="editModalBackdrop">
  <div class="modal">
    <h2>ì¹´ë“œ í¸ì§‘</h2>
    <input type="hidden" id="editCardId">

    <label for="editText">ë¬¸ì¥</label>
    <textarea id="editText"></textarea>

    <label for="editSub">ì‘ì€ ì„¤ëª… (ì„ íƒ)</label>
    <input type="text" id="editSub">

    <label for="editImage">ì‚¬ì§„ ë°”ê¾¸ê¸° (ì„ íƒ)</label>
    <input type="file" id="editImage" accept="image/*">
    <p style="font-size:11px; color:#7f8c8d;">
      ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ë©´ ê¸°ì¡´ ì•„ì´ì½˜/ì‚¬ì§„ì„ ë®ì–´ì”ë‹ˆë‹¤.
    </p>

    <div class="modal-footer">
      <button class="btn btn-secondary" type="button" id="btnEditCancel">ë‹«ê¸°</button>
      <button class="btn btn-primary" type="button" id="btnEditSave">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
  // ===== DOM =====
  const tabsEl = document.getElementById('tabs');
  const tabContentsContainer = document.getElementById('tabContentsContainer');
  const hintStar = document.getElementById('hintStar');

  const btnAddTab = document.getElementById('btnAddTab');
  const btnOpenAddModal = document.getElementById('btnOpenAddModal');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');

  const iconSizeRange = document.getElementById('iconSizeRange');
  const imgSizeRange = document.getElementById('imgSizeRange');
  const cardSizeRange = document.getElementById('cardSizeRange');
  const volumeRange = document.getElementById('volumeRange');
  const rateRange = document.getElementById('rateRange');
  const pitchRange = document.getElementById('pitchRange');
  const voiceSelect = document.getElementById('voiceSelect');

  const sentenceBox = document.getElementById('sentenceBox');
  const btnClear = document.getElementById('btnClear');
  const btnSpeak = document.getElementById('btnSpeak');

  const addModalBackdrop = document.getElementById('addModalBackdrop');
  const addTextInput = document.getElementById('addText');
  const addSubInput = document.getElementById('addSub');
  const addImageInput = document.getElementById('addImage');
  const btnAddCancel = document.getElementById('btnAddCancel');
  const btnAddSave = document.getElementById('btnAddSave');

  const editModalBackdrop = document.getElementById('editModalBackdrop');
  const editCardIdInput = document.getElementById('editCardId');
  const editTextInput = document.getElementById('editText');
  const editSubInput = document.getElementById('editSub');
  const editImageInput = document.getElementById('editImage');
  const btnEditCancel = document.getElementById('btnEditCancel');
  const btnEditSave = document.getElementById('btnEditSave');

  // ===== ì €ì¥ í‚¤ =====
  const STORAGE_TABS           = 'aac_tabs_v2';
  const STORAGE_CARDS          = 'aac_cards_v2';
  const STORAGE_USAGE_COUNTS   = 'aac_usage_counts_v2';
  const STORAGE_SIZE_SETTINGS  = 'aac_size_settings_v3';
  const STORAGE_AUDIO_SETTINGS = 'aac_audio_settings_v2';

  // ===== ìƒíƒœ =====
  let tabsData = [];
  let cards = [];
  let usageCounts = {};
  let activeTabId = null;

  let availableVoices = [];
  let selectedVoice = null;
  let audioSettings = { volume: 1.0, rate: 1.0, pitch: 1.0 };

  // drag ìƒíƒœ
  let draggingTabId = null;
  let draggingCardId = null;
  let dragOverCardId = null;

  // ===== ê¸°ë³¸ íƒ­/ì¹´ë“œ =====
  const DEFAULT_TABS = [
    { id:'star',     name:'â­ ìì£¼',  isDefault:true, order:0 },
    { id:'home',     name:'ğŸ  ì§‘',   isDefault:true, order:1 },
    { id:'school',   name:'ğŸ« í•™êµ', isDefault:true, order:2 },
    { id:'hospital', name:'ğŸ¥ ë³‘ì›', isDefault:true, order:3 },
  ];

  const DEFAULT_CARDS_BASE = [
    { tabId:'home', text:'ë°¥ ë¨¹ê³  ì‹¶ì–´ìš”.', sub:'ë°°ê³ íŒŒìš”', icon:'ğŸš' },
    { tabId:'home', text:'ë¬¼ ë§ˆì‹œê³  ì‹¶ì–´ìš”.', sub:'ëª©ë§ë¼ìš”', icon:'ğŸ’§' },
    { tabId:'home', text:'í™”ì¥ì‹¤ ê°€ê³  ì‹¶ì–´ìš”.', sub:'ê¸‰í•´ìš”', icon:'ğŸš»' },
    { tabId:'home', text:'ì‰¬ê³  ì‹¶ì–´ìš”.', sub:'í”¼ê³¤í•´ìš”', icon:'ğŸ›ï¸' },
    { tabId:'home', text:'TV ë³´ê³  ì‹¶ì–´ìš”.', sub:'ë†€ê³  ì‹¶ì–´ìš”', icon:'ğŸ“º' },
    { tabId:'school', text:'ì„ ìƒë‹˜ ë¶€ë¥´ê¸°', sub:'ì„ ìƒë‹˜ì´ í•„ìš”í•´ìš”', icon:'ğŸ‘©â€ğŸ«' },
    { tabId:'school', text:'ì¹œêµ¬ë‘ ë†€ê³  ì‹¶ì–´ìš”.', sub:'ê°™ì´ ë†€ì', icon:'ğŸ§’' },
    { tabId:'school', text:'ìˆ™ì œ ë„ì™€ì£¼ì„¸ìš”.', sub:'ì–´ë ¤ì›Œìš”', icon:'ğŸ“š' },
    { tabId:'school', text:'ì‰¬ëŠ” ì‹œê°„ì´ì—ìš”?', sub:'ì‰¬ê³  ì‹¶ì–´ìš”', icon:'â°' },
    { tabId:'school', text:'ì•„íŒŒìš”.', sub:'ëª¸ì´ ì´ìƒí•´ìš”', icon:'ğŸ¤’' },
    { tabId:'hospital', text:'ì–´ë””ê°€ ì•„í”ˆì§€ ë§í•˜ê³  ì‹¶ì–´ìš”.', sub:'ì¦ìƒ ì„¤ëª…', icon:'ğŸ©º' },
    { tabId:'hospital', text:'ì£¼ì‚¬ ì‹«ì–´ìš”.', sub:'ë¬´ì„œì›Œìš”', icon:'ğŸ’‰' },
    { tabId:'hospital', text:'ì‰¬ê³  ì‹¶ì–´ìš”.', sub:'ëˆ„ì›Œ ìˆê³  ì‹¶ì–´ìš”', icon:'ğŸ›Œ' },
    { tabId:'hospital', text:'ë¬¼ ì£¼ì„¸ìš”.', sub:'ëª©ë§ë¼ìš”', icon:'ğŸ¥¤' },
    { tabId:'hospital', text:'ë°°ê°€ ì•„íŒŒìš”.', sub:'ë°° í†µì¦', icon:'ğŸ¤¢' },
  ];

  function uuid() {
    return 'id-' + Date.now() + '-' + Math.random().toString(16).slice(2);
  }

  // ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (íƒ­/ì¹´ë“œ/ì‚¬ìš©ê¸°ë¡/í¬ê¸°/ì˜¤ë””ì˜¤) =====
  function loadTabsAndCards() {
    const savedTabs = localStorage.getItem(STORAGE_TABS);
    const savedCards = localStorage.getItem(STORAGE_CARDS);

    if (savedTabs && savedCards) {
      try {
        tabsData = JSON.parse(savedTabs);
        cards    = JSON.parse(savedCards);
        // order ê°’ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì¬ì •ë ¬
        tabsData.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
        cards.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
        return;
      } catch {}
    }

    // ì´ˆê¸°ê°’ ì„¸íŒ…
    tabsData = JSON.parse(JSON.stringify(DEFAULT_TABS));
    cards = DEFAULT_CARDS_BASE.map((c, idx) => ({
      id: 'base-' + c.tabId + '-' + idx,
      tabId: c.tabId,
      text: c.text,
      sub: c.sub || '',
      icon: c.icon || '',
      imageData: null,
      isDefault: true,
      order: idx
    }));
    saveTabsAndCards();
  }

  function saveTabsAndCards() {
    localStorage.setItem(STORAGE_TABS, JSON.stringify(tabsData));
    localStorage.setItem(STORAGE_CARDS, JSON.stringify(cards));
  }

  function loadUsageCounts() {
    const saved = localStorage.getItem(STORAGE_USAGE_COUNTS);
    if (saved) {
      try { usageCounts = JSON.parse(saved); }
      catch { usageCounts = {}; }
    }
  }
  function saveUsageCounts() {
    localStorage.setItem(STORAGE_USAGE_COUNTS, JSON.stringify(usageCounts));
  }

  function loadSizeSettings() {
    const saved = localStorage.getItem(STORAGE_SIZE_SETTINGS);
    if (saved) {
      try {
        const s = JSON.parse(saved);
        if (s.iconSize) {
          iconSizeRange.value = s.iconSize;
          document.documentElement.style.setProperty('--icon-size', s.iconSize + 'px');
        }
        if (s.imgHeight) {
          imgSizeRange.value = s.imgHeight;
          document.documentElement.style.setProperty('--image-height', s.imgHeight + 'px');
        }
        if (s.cardHeight) {
          cardSizeRange.value = s.cardHeight;
          document.documentElement.style.setProperty('--card-min-height', s.cardHeight + 'px');
        }
      } catch {}
    } else {
      document.documentElement.style.setProperty('--icon-size', iconSizeRange.value + 'px');
      document.documentElement.style.setProperty('--image-height', imgSizeRange.value + 'px');
      document.documentElement.style.setProperty('--card-min-height', cardSizeRange.value + 'px');
    }
  }
  function saveSizeSettings() {
    const s = {
      iconSize: parseInt(iconSizeRange.value, 10),
      imgHeight: parseInt(imgSizeRange.value, 10),
      cardHeight: parseInt(cardSizeRange.value, 10)
    };
    localStorage.setItem(STORAGE_SIZE_SETTINGS, JSON.stringify(s));
  }
  iconSizeRange.addEventListener('input', () => {
    document.documentElement.style.setProperty('--icon-size', iconSizeRange.value + 'px');
    saveSizeSettings();
  });
  imgSizeRange.addEventListener('input', () => {
    document.documentElement.style.setProperty('--image-height', imgSizeRange.value + 'px');
    saveSizeSettings();
  });
  cardSizeRange.addEventListener('input', () => {
    document.documentElement.style.setProperty('--card-min-height', cardSizeRange.value + 'px');
    saveSizeSettings();
  });

  function loadAudioSettings() {
    const saved = localStorage.getItem(STORAGE_AUDIO_SETTINGS);
    if (saved) {
      try { audioSettings = JSON.parse(saved); }
      catch { audioSettings = { volume:1.0, rate:1.0, pitch:1.0 }; }
    }
    volumeRange.value = Math.round((audioSettings.volume ?? 1.0) * 100);
    rateRange.value   = Math.round((audioSettings.rate   ?? 1.0) * 100);
    pitchRange.value  = Math.round((audioSettings.pitch  ?? 1.0) * 100);
  }
  function saveAudioSettings() {
    localStorage.setItem(STORAGE_AUDIO_SETTINGS, JSON.stringify(audioSettings));
  }
  volumeRange.addEventListener('input', () => {
    audioSettings.volume = parseInt(volumeRange.value, 10) / 100;
    saveAudioSettings();
  });
  rateRange.addEventListener('input', () => {
    audioSettings.rate = parseInt(rateRange.value, 10) / 100;
    saveAudioSettings();
  });
  pitchRange.addEventListener('input', () => {
    audioSettings.pitch = parseInt(pitchRange.value, 10) / 100;
    saveAudioSettings();
  });

  // ===== ìŒì„± =====
  function loadVoices() {
    if (!window.speechSynthesis) return;
    availableVoices = window.speechSynthesis.getVoices();
    if (!availableVoices.length) return;

    voiceSelect.innerHTML = '<option value="">ê¸°ë³¸</option>';

    const ko = availableVoices.filter(v => v.lang && v.lang.startsWith('ko'));
    const other = availableVoices.filter(v => !v.lang || !v.lang.startsWith('ko'));

    function addGroup(list, label) {
      if (!list.length) return;
      const og = document.createElement('optgroup');
      og.label = label;
      list.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = v.name + (v.default ? ' (ê¸°ë³¸)' : '');
        og.appendChild(opt);
      });
      voiceSelect.appendChild(og);
    }
    addGroup(ko, 'í•œêµ­ì–´');
    addGroup(other, 'ê¸°íƒ€');

    if (audioSettings.voiceName) {
      voiceSelect.value = audioSettings.voiceName;
      selectedVoice = availableVoices.find(v => v.name === audioSettings.voiceName) || null;
    }

    voiceSelect.addEventListener('change', () => {
      const name = voiceSelect.value;
      selectedVoice = availableVoices.find(v => v.name === name) || null;
      audioSettings.voiceName = name || null;
      saveAudioSettings();
    });
  }
  if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 300);
  }

  // ===== ë Œë”ë§ =====
  function renderTabs() {
    tabsEl.innerHTML = '';
    tabsData.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));

    tabsData.forEach(tab => {
      const btn = document.createElement('button');
      btn.className = 'tab';
      btn.dataset.id = tab.id;
      btn.draggable = true;
      btn.textContent = tab.name;

      if (tab.id === activeTabId) btn.classList.add('active');

      if (!tab.isDefault && tab.id !== 'star') {
        const del = document.createElement('button');
        del.className = 'tab-delete';
        del.type = 'button';
        del.textContent = 'ğŸ—‘';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!confirm(`"${tab.name}" íƒ­ê³¼ ì•ˆì˜ ì¹´ë“œë“¤ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
          tabsData = tabsData.filter(t => t.id !== tab.id);
          cards = cards.filter(c => c.tabId !== tab.id);
          saveTabsAndCards();
          if (activeTabId === tab.id) activeTabId = 'home';
          renderAll();
        });
        btn.appendChild(del);
      }

      // í´ë¦­ = íƒ­ ì „í™˜
      btn.addEventListener('click', () => {
        const targetId = tab.id;
        if (activeTabId === targetId) return;
        activeTabId = targetId;
        renderAll();
      });

      // ë“œë˜ê·¸ ì´ë²¤íŠ¸
      btn.addEventListener('dragstart', (e) => {
        draggingTabId = tab.id;
        e.dataTransfer.effectAllowed = 'move';
      });
      btn.addEventListener('dragend', () => {
        draggingTabId = null;
        document.querySelectorAll('.tab.drag-over').forEach(el => el.classList.remove('drag-over'));
      });
      btn.addEventListener('dragover', (e) => {
        if (!draggingTabId || draggingTabId === tab.id) return;
        e.preventDefault();
        btn.classList.add('drag-over');
      });
      btn.addEventListener('dragleave', () => {
        btn.classList.remove('drag-over');
      });
      btn.addEventListener('drop', (e) => {
        e.preventDefault();
        btn.classList.remove('drag-over');
        if (!draggingTabId || draggingTabId === tab.id) return;
        // ìˆœì„œ ì¬ë°°ì—´
        const fromIndex = tabsData.findIndex(t => t.id === draggingTabId);
        const toIndex   = tabsData.findIndex(t => t.id === tab.id);
        if (fromIndex === -1 || toIndex === -1) return;
        const [moved] = tabsData.splice(fromIndex, 1);
        tabsData.splice(toIndex, 0, moved);
        // order ë‹¤ì‹œ ë¶€ì—¬
        tabsData.forEach((t,i) => t.order = i);
        saveTabsAndCards();
        renderTabs();
      });

      tabsEl.appendChild(btn);
    });
  }

  function renderTabContents() {
    tabContentsContainer.innerHTML = '';

    tabsData.forEach(tab => {
      const grid = document.createElement('div');
      grid.id = `content-${tab.id}`;
      grid.className = 'grid';
      grid.style.display = (activeTabId === tab.id) ? 'grid' : 'none';

      if (tab.id === 'star') {
        renderStarTab(grid);
      } else {
        const list = cards
          .filter(c => c.tabId === tab.id)
          .sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
        list.forEach(card => {
          grid.appendChild(createCardElement(card));
        });
      }
      tabContentsContainer.appendChild(grid);
    });

    hintStar.style.display = (activeTabId === 'star') ? 'block' : 'none';
  }

  function renderStarTab(container) {
    container.innerHTML = '';
    const arr = Object.entries(usageCounts)
      .sort((a,b) => b[1] - a[1])
      .slice(0, 20);

    if (!arr.length) {
      const msg = document.createElement('div');
      msg.style.fontSize = '12px';
      msg.style.color = '#95a5a6';
      msg.textContent = 'ì•„ì§ ìì£¼ ì“°ëŠ” ë§ì´ ì—†ì–´ìš”. ìœ„ íƒ­ì—ì„œ ë§ì„ ë§ì´ ëˆŒëŸ¬ë³´ë©´ ì´ê³³ì— ëª¨ì—¬ìš”.';
      container.appendChild(msg);
      return;
    }

    arr.forEach(([text, count]) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.say = text;
      card.draggable = false; // ë³„ íƒ­ ì¹´ë“œëŠ” ì •ë ¬ X

      const icon = document.createElement('div');
      icon.className = 'icon';
      icon.textContent = 'â­';

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = text;

      const sub = document.createElement('div');
      sub.className = 'sub';
      sub.textContent = `ì‚¬ìš© íšŸìˆ˜: ${count}`;

      card.appendChild(icon);
      card.appendChild(label);
      card.appendChild(sub);
      card.addEventListener('click', () => onCardClick(text));

      container.appendChild(card);
    });
  }

  function createCardElement(cardData) {
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.id = cardData.id;
    el.dataset.say = cardData.text;
    el.draggable = true;

    // í¸ì§‘ ë²„íŠ¼
    const editBtn = document.createElement('button');
    editBtn.className = 'card-edit-btn';
    editBtn.type = 'button';
    editBtn.textContent = 'â‹®';
    editBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      openEditModal(cardData.id);
    });
    el.appendChild(editBtn);

    // ì‚­ì œ ë²„íŠ¼
    const delBtn = document.createElement('button');
    delBtn.className = 'card-delete-btn';
    delBtn.type = 'button';
    delBtn.textContent = 'Ã—';
    delBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!confirm('ì´ ë²„íŠ¼ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      cards = cards.filter(c => c.id !== cardData.id);
      saveTabsAndCards();
      renderAll();
    });
    el.appendChild(delBtn);

    // ì´ë¯¸ì§€ or ì•„ì´ì½˜
    if (cardData.imageData) {
      const img = document.createElement('img');
      img.className = 'card-img';
      img.src = cardData.imageData;
      img.alt = cardData.text;
      el.appendChild(img);
    } else if (cardData.icon) {
      const icon = document.createElement('div');
      icon.className = 'icon';
      icon.textContent = cardData.icon;
      el.appendChild(icon);
    } else {
      const icon = document.createElement('div');
      icon.className = 'icon';
      icon.textContent = 'ğŸ–¼ï¸';
      el.appendChild(icon);
    }

    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = cardData.text;
    el.appendChild(label);

    if (cardData.sub) {
      const sub = document.createElement('div');
      sub.className = 'sub';
      sub.textContent = cardData.sub;
      el.appendChild(sub);
    }

    el.addEventListener('click', () => onCardClick(cardData.text));

    // ì¹´ë“œ ë“œë˜ê·¸ ì •ë ¬
    el.addEventListener('dragstart', (e) => {
      draggingCardId = cardData.id;
      dragOverCardId = null;
      el.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    el.addEventListener('dragend', () => {
      draggingCardId = null;
      dragOverCardId = null;
      document.querySelectorAll('.card.drag-over').forEach(c => c.classList.remove('drag-over'));
      document.querySelectorAll('.card.dragging').forEach(c => c.classList.remove('dragging'));
    });
    el.addEventListener('dragover', (e) => {
      if (!draggingCardId || draggingCardId === cardData.id) return;
      e.preventDefault();
      el.classList.add('drag-over');
      dragOverCardId = cardData.id;
    });
    el.addEventListener('dragleave', () => {
      el.classList.remove('drag-over');
    });
    el.addEventListener('drop', (e) => {
      e.preventDefault();
      el.classList.remove('drag-over');
      if (!draggingCardId || draggingCardId === cardData.id) return;

      const sameTabCards = cards
        .filter(c => c.tabId === cardData.tabId)
        .sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
      const fromIndex = sameTabCards.findIndex(c => c.id === draggingCardId);
      const toIndex   = sameTabCards.findIndex(c => c.id === cardData.id);
      if (fromIndex === -1 || toIndex === -1) return;

      const [moved] = sameTabCards.splice(fromIndex, 1);
      sameTabCards.splice(toIndex, 0, moved);
      sameTabCards.forEach((c,i) => c.order = i);

      // ì „ì²´ cardsì— order ë°˜ì˜
      cards.forEach(c => {
        const updated = sameTabCards.find(sc => sc.id === c.id);
        if (updated) c.order = updated.order;
      });

      saveTabsAndCards();
      renderAll();
    });

    return el;
  }

  function renderAll() {
    renderTabs();
    renderTabContents();
  }

  // ===== ì¹´ë“œ í´ë¦­ =====
  function onCardClick(text) {
    if (sentenceBox.textContent.trim()) {
      sentenceBox.textContent += ' ' + text;
    } else {
      sentenceBox.textContent = text;
    }
    speak(text);
    usageCounts[text] = (usageCounts[text] || 0) + 1;
    saveUsageCounts();
    if (activeTabId === 'star') renderAll();
  }

  // ===== ë¬¸ì¥ì°½ =====
  btnClear.addEventListener('click', () => {
    sentenceBox.textContent = '';
  });
  btnSpeak.addEventListener('click', () => {
    const text = sentenceBox.textContent.trim();
    if (!text) return;
    speak(text);
  });

  // ===== TTS =====
  function speak(text) {
    if (!window.speechSynthesis) {
      alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ko-KR';
    u.rate = audioSettings.rate ?? 1.0;
    u.pitch = audioSettings.pitch ?? 1.0;
    u.volume = audioSettings.volume ?? 1.0;
    if (selectedVoice) {
      u.voice = selectedVoice;
      if (!u.voice.lang) u.lang = 'ko-KR';
    }
    window.speechSynthesis.speak(u);
  }

  // ===== íƒ­ ì¶”ê°€ =====
  btnAddTab.addEventListener('click', () => {
    const name = prompt('ìƒˆ íƒ­ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.\nì˜ˆ: ë†€ì´, ë°–ì—, ê°€ì¡±');
    if (!name) return;
    const id = 'tab-' + uuid();
    const order = tabsData.length ? Math.max(...tabsData.map(t => t.order ?? 0)) + 1 : 0;
    tabsData.push({ id, name, isDefault:false, order });
    saveTabsAndCards();
    activeTabId = id;
    renderAll();
  });

  // ===== ì‚¬ìš©ì ì¹´ë“œ ì¶”ê°€ =====
  function openAddModal() {
    if (activeTabId === 'star') {
      alert('â­ ìì£¼ íƒ­ì´ ì•„ë‹Œ, ë‹¤ë¥¸ íƒ­ì—ì„œ ë²„íŠ¼ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
      return;
    }
    addTextInput.value = '';
    addSubInput.value = '';
    addImageInput.value = '';
    addModalBackdrop.style.display = 'flex';
  }
  function closeAddModal() {
    addModalBackdrop.style.display = 'none';
  }
  btnOpenAddModal.addEventListener('click', openAddModal);
  btnAddCancel.addEventListener('click', closeAddModal);
  addModalBackdrop.addEventListener('click', (e) => {
    if (e.target === addModalBackdrop) closeAddModal();
  });

  btnAddSave.addEventListener('click', () => {
    const text = addTextInput.value.trim();
    const sub  = addSubInput.value.trim();
    const file = addImageInput.files[0] || null;
    if (!text) {
      alert('ë§í•˜ê³  ì‹¶ì€ ë¬¸ì¥ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      return;
    }
    const sameTabCards = cards.filter(c => c.tabId === activeTabId);
    const nextOrder = sameTabCards.length ? Math.max(...sameTabCards.map(c => c.order ?? 0)) + 1 : 0;

    function finalize(imageData) {
      cards.push({
        id: uuid(),
        tabId: activeTabId,
        text,
        sub,
        icon: '',
        imageData: imageData || null,
        isDefault: false,
        order: nextOrder
      });
      saveTabsAndCards();
      closeAddModal();
      renderAll();
    }

    if (file) {
      const reader = new FileReader();
      reader.onload = e => finalize(e.target.result);
      reader.readAsDataURL(file);
    } else {
      finalize(null);
    }
  });

  // ===== ì¹´ë“œ í¸ì§‘ =====
  function openEditModal(cardId) {
    const card = cards.find(c => c.id === cardId);
    if (!card) return;
    editCardIdInput.value = card.id;
    editTextInput.value = card.text;
    editSubInput.value = card.sub || '';
    editImageInput.value = '';
    editModalBackdrop.style.display = 'flex';
  }
  function closeEditModal() {
    editModalBackdrop.style.display = 'none';
  }
  btnEditCancel.addEventListener('click', closeEditModal);
  editModalBackdrop.addEventListener('click', (e) => {
    if (e.target === editModalBackdrop) closeEditModal();
  });

  btnEditSave.addEventListener('click', () => {
    const id = editCardIdInput.value;
    const card = cards.find(c => c.id === id);
    if (!card) {
      closeEditModal();
      return;
    }
    const newText = editTextInput.value.trim();
    const newSub  = editSubInput.value.trim();
    const file    = editImageInput.files[0] || null;
    if (!newText) {
      alert('ë¬¸ì¥ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      return;
    }

    function finalize(imageData) {
      card.text = newText;
      card.sub  = newSub;
      if (imageData) {
        card.imageData = imageData;
      }
      saveTabsAndCards();
      closeEditModal();
      renderAll();
    }

    if (file) {
      const reader = new FileReader();
      reader.onload = e => finalize(e.target.result);
      reader.readAsDataURL(file);
    } else {
      finalize(null);
    }
  });

  // ===== ë°ì´í„° ë‚´ë³´ë‚´ê¸° / ë¶ˆëŸ¬ì˜¤ê¸° =====
  function exportData() {
    const data = {
      version: 1,
      tabsData,
      cards,
      usageCounts,
      sizeSettings: JSON.parse(localStorage.getItem(STORAGE_SIZE_SETTINGS) || 'null'),
      audioSettings
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
    a.href = url;
    a.download = `aac-board-backup-${date}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importDataFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.tabsData || !data.cards) {
          alert('í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒŒì¼ì…ë‹ˆë‹¤.');
          return;
        }

        // ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸°
        tabsData    = data.tabsData;
        cards       = data.cards;
        usageCounts = data.usageCounts || {};

        // ì €ì¥
        saveTabsAndCards();
        saveUsageCounts();

        if (data.sizeSettings) {
          localStorage.setItem(STORAGE_SIZE_SETTINGS, JSON.stringify(data.sizeSettings));
        }
        if (data.audioSettings) {
          audioSettings = data.audioSettings;
          saveAudioSettings();
        }

        // UI ë‹¤ì‹œ ë¡œë“œ
        loadSizeSettings();
        loadAudioSettings();
        activeTabId = 'home';
        renderAll();

        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (íƒ­/ì¹´ë“œ êµ¬ì„±ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤)');
      } catch (err) {
        console.error(err);
        alert('ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };
    reader.readAsText(file, 'utf-8');
  }

  btnExport.addEventListener('click', exportData);

  btnImport.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!confirm('ì´ íŒŒì¼ì˜ ë‚´ìš©ìœ¼ë¡œ í˜„ì¬ íƒ­/ì¹´ë“œ êµ¬ì„±ì„ ë®ì–´ì“¸ê¹Œìš”?')) {
      e.target.value = '';
      return;
    }
    importDataFromFile(file);
    e.target.value = ''; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì´ˆê¸°í™”
  });

  // ===== ì´ˆê¸° ì‹¤í–‰ =====
  function init() {
    loadTabsAndCards();
    loadUsageCounts();
    loadSizeSettings();
    loadAudioSettings();
    activeTabId = activeTabId || 'home';
    renderAll();
  }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
